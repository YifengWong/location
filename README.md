# 室内定位系统

## 1. 可行性分析

### 1.1 背景
随着移动互联网的飞速发展，基于地理位置的服务在许多应用上发挥着越来越重要的作用。如今大多数定位应用都是基于全球定位系统（Global Positioning System，简称 GPS）或基站等室外定位环境，而对于人们大部分时间活动的室内环境，GPS卫星信号收到混凝土等众多障碍物的阻挡导致信号严重衰减，定位精度很难达到要求。因此，方便而且精确的室内定位技术具有重要的商业价值。

### 1.2 实施
本文打算从以下几个方面进行研究，分别是视频店铺正面关键帧提取算法，基于基于深度学习的图像匹配算法，角度加权的鲁棒定位算法，最后需要使用并行计算等方法对定位系统优化，缩短整个定位系统的响应时间。

- 视频店铺正面关键帧提取算法：由于视频数据量比图像更大，而且处理视频所需要消耗的时间通常比图像更长，因此需要在视频中抽取出店铺正面的关键帧，以及视频拍摄该帧是对应的传感器角度信息，以便后期定位阶段进行处理。通过Faster R-CNN提取出视频中的店铺招牌区域，并使用视频目标跟踪算法对店铺招牌区域进行跟踪，进而在视频中得到店铺正面的照片。通过线性插值的方法可以将离散的传感器数据对应到视频的每一帧当中，为后续图像匹配与定位做准备。
- 基于深度学习的图像匹配算法：使用了目前较为热门的深度学习提高图像匹配算法的精度。针对不同的训练不同的卷积神经网络，对于提取出的招牌区域确认视频中提取出的关键帧分别对应哪些店铺。最后利用视频中店铺连续性的特征，自动过滤可能匹配错误的结果，提高匹配准确率。
- 角度加权的鲁棒定位算法：在基于罗盘绝对角度的定位模型中，找到影响定位结果最明显的分量，加上权重减弱该分量对定位结果的影响，提高定位结果的鲁棒性。同时考虑到用户拍摄的位置或者视频中提取到的关键帧不是店铺正中心，加上偏移量对结果的影响，使得权重更适合基于图像定位的场景。


## 2. 需求说明

### 2.1 系统

#### 2.1.1 概述
作为系统，我希望能够为用户提供室内定位功能。

#### 2.1.2 细则
1. 用户可以通过移动终端向系统提供特定的图像、视频等信息。
2. 系统可以使用基于深度学习的图像匹配算法，向用户提供位置信息。

### 2.2 服务端

#### 2.2.1 概述
作为服务端，我希望能够作为客户端和算法端的中间模块，帮助两端解耦。

#### 2.2.2 细则
1. 服务端应持续地为客户端提供连接服务，能够接收客户端通过网络发送的图片等信息。
2. 服务端应能够返回结果等信息给客户端。
3. 服务端应处理客户端传来的图片等信息，并顺序处理后交给算法端。
4. 服务端应能接收算法端定位的结果信息。

### 2.3 客户端

#### 2.3.1 概述
作为客户端，我希望能够给用户在移动终端上的良好定位体验。

#### 2.3.2 细则
1. 客户端应能够捕捉图片、传感器等元信息，并发送给服务端。
2. 客户端应能够接收来自服务端的返回结果信息，并呈现给用户。

### 2.4 算法端

#### 2.4.1 概述
作为算法端，我希望能够处理特定的图像（流），并通过深度学习完成的模型进行定位。

#### 2.4.2 细则
1. 算法端应接收来自服务端排序完成的图片帧流，这些图片中含有定位所需的信息。
2. 算法端应返回给服务端一个定位的结果信息，成功或失败。



## 3. 概要设计说明


## 4. 详细设计说明


## 5. 软件维护



## 1. 后台模块组成

#### 1.1 逻辑流程
1. 用户使用手机端App拍摄视频过程中，会间隔一定时间发送图片帧到Java Web http接口
2. Java Web应用接收图片并整理顺序保证时序无错乱后，将图片帧存放至本地Redis
服务中
3. C++部分代码提供封装好的接口，可以从本地Redis中读取图片，并提交给算法进行处理
4. 算法处理完毕后返回结果，存放在Redis服务中
5. Java Web可以从Redis中定时查询所需结果

#### 1.2 Java Web应用中使用技术
1. Spring MVC框架
2. Jedis 操作Redis
3. Spring框架


#### 1.3 C++ 入口封装使用技术
1. hiredis 操作Redis
2. C++ Socket


## 2. Java Web应用

#### 2.1 主要包 location.message内容
![](https://github.com/YifengWong/location/blob/master/docs/pics/java-message-package-classes.png)

#### 2.2 实体类 Message

1. 作为与C++沟通的主要消息实体，可以用于保持一个具体的消息。
2. 一个具体的消息分为多种，有图片类型，结果类型，可以与C++算法部分进行完备的交流。
3. 消息还可以保持前端发送过来的传感器数据，作为参数存放。
4. 有序列化与反序列化方法，作为内存对象写入与C++一致。

#### 2.3 AbstractMsgService以及子类不同实现RedisMsgService和SocketMsgService

1. 该部分的类主要用于与C++进行通信。有Redis方法以及Socket方法。
2. 抽象类实现了共同的方法，且保持有MsgManger对象，用于对消息的管理。
3. RedisMsgService实现了针对Redis通信方式的线程启动。
4. SocketMsgService实现了针对Socket通信方式的线程启动。


#### 2.4 消息管理中心 MsgManager

1. 该类用于管理消息，作为Java端的消息中心，对外提供访问方法。
2. 无论是获取消息还是发送消息，都可以调用MsgManager的方法，由其进行统一处理，这样便于优化。


#### 2.5 其余内容

作为一个普通Web应用，使用Spring定义的Controller提供Web接口。


## 3. C++ 入口

#### 3.1 主要内容

作为一个功能模块，提供与Java Web端通信与获取消息的能力。
算法端中可以直接使用该模块作为组件获取图片、返回结果等。
模块msg_service中的类提供了方法，命名与功能均与java内容一致。实现方式有所区别。


#### 3.2 与Redis通信

使用HiRedis框架，需要链接与头文件引用。


#### 3.3 序列化

讲Message类的对象，通过内存拷贝的方式进行传输。这样可以提高效率而且易于维护，Java与C++统一此
传输格式。